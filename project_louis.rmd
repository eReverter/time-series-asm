---
title: "ASM_project_louis"
output: html_document
date: '2022-12-25'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(forecast)
```

## Data

Data from 1997 until 2022 of flu. 
pre.who is all combined cases up to 2015-16. who.clinical and who.public represent cases after 2015 with the former counting Clinical Lab positives and the latter counting results of the Public Health Labs. These will later be combined into one. 

```{r}
pre.who = read.csv("WHO_NREVSS_Combined_prior_to_2015_16.csv", header=TRUE, skip=1) 
head(pre.who)

who.clinical = read.csv("WHO_NREVSS_Clinical_Labs.csv", header=TRUE, skip=1)
head(who.clinical)

who.public = read.csv("WHO_NREVSS_Public_Health_Labs.csv", header=TRUE, skip=1)
head(who.public)
```


```{r}
pre.who.clean = pre.who %>%
  filter(YEAR > 1997) %>%
  mutate(DATE=sprintf("%s_%02d", YEAR, WEEK)) %>%
  mutate(INF_ALL=ceiling(TOTAL.SPECIMENS * PERCENT.POSITIVE / 100)) %>%
  filter(WEEK < 53) %>%
  select(c(DATE, WEEK, INF_ALL)) %>%
  arrange(DATE) # Until 2015_39

who.clinical.clean = who.clinical %>% # From 2015_40 onwards
  mutate(DATE=sprintf("%s_%02d", YEAR, WEEK)) %>% 
  mutate(INF_ALL=ceiling(TOTAL.SPECIMENS * PERCENT.POSITIVE / 100)) %>%
  filter(WEEK < 53) %>%
  select(c(DATE, WEEK, INF_ALL)) %>%
  arrange(DATE) 

flu.strains = c("A..2009.H1N1.", "A..H3.", "A..Subtyping.not.Performed.", "B", "BVic", "BYam", "H3N2v")

who.public.clean = who.public %>%
  mutate(DATE=sprintf("%s_%02d", YEAR, WEEK)) %>% 
  mutate(INF_ALL=rowSums(across(all_of(flu.strains)))) %>%
  filter(WEEK < 53) %>%
  select(c(DATE, WEEK, INF_ALL)) %>%
  arrange(DATE)

post.who.clean = who.clinical.clean %>%
  left_join(who.public.clean, by="DATE") %>%
  mutate(INF_ALL=INF_ALL.x + INF_ALL.y) %>%
  select(DATE, INF_ALL)


flu.usa = pre.who.clean %>%
  select(DATE, INF_ALL) %>%
  bind_rows(post.who.clean)

idx_end <- which(flu.usa$DATE == "2020_01") #All weeks including this one should be ommitted. This way COVID is not 
idxs_to_keep <- seq(1, idx_end-1, by=1) # included in the dataset and there are exactly 52 weeks per year. 

flu.usa.final <- flu.usa[idxs_to_keep,]

#flu.usa.day.dates = flu.usa %>% mutate(DATE=as.Date(paste(flu.usa$DATE,"1", sep = "_"), '%Y_%U_%w'))
```

```{r}
flu.usa.ts = ts(flu.usa.final$INF_ALL, start=1998,frequency=52) #Lets not include covid for first analysis
serie = flu.usa.ts
```

```{r}
par(mfrow=c(1,2))
plot(serie)
abline(v=1990:2022,col=4,lty=3)
plot(log(serie))
abline(v=1990:2022,col=4,lty=3)
```

```{r}
boxplot(serie~floor(time(serie)))
```

```{r}
boxplot(log(serie+1)~floor(time(serie))) #Do log(x+1) transformation to evade exploding log of zero values. 
```

```{r}
mserie = matrix(serie, ncol=52, byrow=TRUE)

plot(serie)
serie
m = apply(mserie, 1, mean) #Calculate Mean for each year
v = apply(mserie, 1, var) #Calculate Variance for each year
plot(v ~ m)
abline(lm(v ~ m), col=2, lty=3)
```

```{r}
lnserie <- log(serie + 1)
```

```{r}
monthplot(lnserie)
```

```{r}
ts.plot(matrix(lnserie, nrow=52))
```


```{r}
d52lnserie <- diff(lnserie,52)
plot(d52lnserie)
abline(h=0)
```

```{r}
monthplot(d52lnserie)
```

```{r}
d1d52lnserie <- diff(d52lnserie)
plot(d1d52lnserie)
abline(h=0)
```

```{r}
d1d1d52lnserie <- diff(d1d52lnserie)
plot(d1d1d52lnserie)
abline(h=0)
```

```{r}
var(lnserie)
var(d52lnserie)
var(d1d52lnserie)
var(d1d1d52lnserie)
```
Let's first look for appropriate models for the seasonal part using ACF and PACF (with high lag.max as there are 52 lag in between each seasonal one)

```{r}
par(mfrow=c(1,2))
#For Seasonal Part
acf(d1d52lnserie, ylim=c(-1,1), lag.max = 400,col=c(2,rep(1,51)),lwd=2) 
pacf(d1d52lnserie, ylim=c(-1,1), lag.max = 400,col=c(rep(1,51),2),lwd=2) 
```
In this case, only the seasonal pattern is looked into. FOUR propositions:
- ARMA(P = 5, Q = 0)_52
- ARMA(P = 0, Q = 4)_52
- ARMA(P = 0, Q = 1)_52
- ARMA(P = 1, Q = 1)_52 & add parameters later

Now lets look at the Regular part:

```{r}
par(mfrow=c(1,2))
#For Regular Part
acf(d1d52lnserie, ylim=c(-1,1), lag.max = 80,col=c(2,rep(1,51)),lwd=2) 
pacf(d1d52lnserie, ylim=c(-1,1), lag.max = 80,col=c(rep(1,51),2),lwd=2) 
```
Four propositions:
- ARMA(p=5, q=0)
- ARMA(p=10, q=0)
- ARMA(p=0, q=5)
- ARMA(p=1, q=1) and add parameters


Now first for ARIMA(5,1,0)(5,1,0)_52

```{r}
# Adapted from https://rstudio-pubs-static.s3.amazonaws.com/616669_ad9d837f805f4e44aec8df5bc6219b7d.html
d=1
DD=1
per=52
for(p in 1:4){
  for(q in 1:2){
    for(P in 0:4){
      for(Q in 0:2){
        if(p+d+q+P+DD+Q<=10){
          try({
          model<-arima(lnserie, order = c((p),d,(q)), seasonal = list(order=c((P),DD,(Q)), period=per))
          pval<-Box.test(model$residuals, lag=log(length(model$residuals)))
          sse<-sum(model$residuals^2)
          cat(p,d,q,P,DD,Q,per, 'AIC=', model$aic, ' SSE=',sse,' p-VALUE=', pval$p.value,'\n')
          })
        }
      }
    }
  }
}
```

```{r}
model<-arima(lnserie, order = c(4,1,2), seasonal = list(order=c(0,1,1), period=52))
```

```{r}
tsdiag(model,gof=150)
```
```{r}
par(mfrow=c(1,2))
acf(resid(model), ylim=c(-1,1), lag.max = 400,col=c(2,rep(1,11)),lwd=2)
pacf(resid(model), ylim=c(-1,1), lag.max = 400,col=c(rep(1,11),2),lwd=2)
```

Two Year Forecast...
```{r}
predicted=forecast(model, 104)
plot(predicted, xlim=c(1997,2022), xlab='Years')
#lines(ts(tail(lnserie, 52), frequency=52, start=c(20, 4), end=c(21, 3)), col="red")
```



